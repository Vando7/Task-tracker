{% extends 'base.html' %}

{% load static i18n %}
{% load custom_filters %}

{% block viewSpecificCss %}
  <link rel="stylesheet" href="{% static 'css/task_index.css' %}" />
{% endblock viewSpecificCss %}

{% block help_btn %}
  <button type="button" class="btn btn-dark help-btn help-btn-pulsing" data-bs-toggle="modal" data-bs-target="#helpModal">
    <i class="bi bi-question-circle"></i>
  </button>

  <!-- Modal -->
  <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header" style="border: 0;">
          <h1 class="modal-title fs-5" id="helpModalLabel">Help</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" style="border: 0;">
          <div class="accordion" id="helpAccordion">
            <!-- User Profile and Navigation -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                  üìã User Profile and Navigation
                </button>
              </h2>
              <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#helpAccordion">
                <div class="accordion-body">
                  <p style="padding: 10px; line-height: 1.5;">
                    On the left sidebar, you'll find your profile and the main navigation menu. Click on your profile picture to access account settings, manage your workspaces, or log out. Below your profile, you'll see links to the home page, create new tasks, and navigate through the floors and rooms in your house.
                  </p>
                  <img src="static/images/user-profile-nav.png" alt="User Profile and Navigation" class="img-fluid mb-3" style="max-width: 100%; padding: 10px;">
                </div>
              </div>
            </div>

            <!-- Main Sections -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingTwo">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                  üè† Main Sections
                </button>
              </h2>
              <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#helpAccordion">
                <div class="accordion-body">
                  <p style="padding: 10px; line-height: 1.5;">
                    Here's a quick rundown of the main sections:
                    <ul>
                      <li><strong>Home Button:</strong> Takes you back to the main dashboard.</li>
                      <li><strong>New Task Button:</strong> Use this to add a new task quickly.</li>
                      <li><strong>Floor Navigation:</strong> Click on a floor to expand and see the rooms within it.</li>
                    </ul>
                  </p>
                  <img src="static/images/main-sections.png" alt="Main Sections" class="img-fluid mb-3" style="max-width: 100%; padding: 10px;">
                </div>
              </div>
            </div>

            <!-- Floor and Room Cards -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingThree">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                  üè¢ Floor and Room Cards
                </button>
              </h2>
              <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#helpAccordion">
                <div class="accordion-body">
                  <p style="padding: 10px; line-height: 1.5;">
                    Each floor has its own colored section with all its rooms listed. Room cards display icons, names, and the number of tasks. You can edit, view, or delete rooms using the icons on each card.
                  </p>
                  <img src="static/images/floor-room-cards.png" alt="Floor and Room Cards" class="img-fluid mb-3" style="max-width: 100%; padding: 10px;">
                </div>
              </div>
            </div>

            <!-- Tasks Count Indicator -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingFour">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                  üî¢ Tasks Count Indicator
                </button>
              </h2>
              <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#helpAccordion">
                <div class="accordion-body">
                  <p style="padding: 10px; line-height: 1.5;">
                    Next to each room name, you'll see a number indicating the total tasks in that room. We're working on adding a feature to filter tasks so you can see only the pending ones.
                  </p>
                  <img src="static/images/task-count-indicator.png" alt="Tasks Count Indicator" class="img-fluid mb-3" style="max-width: 100%; padding: 10px;">
                </div>
              </div>
            </div>

            <!-- Interactive Elements -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingFive">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">
                  üéÆ Interactive Elements
                </button>
              </h2>
              <div id="collapseFive" class="accordion-collapse collapse" aria-labelledby="headingFive" data-bs-parent="#helpAccordion">
                <div class="accordion-body">
                  <p style="padding: 10px; line-height: 1.5;">
                    At the bottom of each section, you can add new floors or rooms. Use the icons on each card to manage floors and rooms easily.
                  </p>
                  <img src="static/images/interactive-elements.png" alt="Interactive Elements" class="img-fluid mb-3" style="max-width: 100%; padding: 10px;">
                </div>
              </div>
            </div>

            <!-- Detailed View Navigation -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingSix">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSix" aria-expanded="false" aria-controls="collapseSix">
                  üîç Detailed View Navigation
                </button>
              </h2>
              <div id="collapseSix" class="accordion-collapse collapse" aria-labelledby="headingSix" data-bs-parent="#helpAccordion">
                <div class="accordion-body">
                  <p style="padding: 10px; line-height: 1.5;">
                    Click on any room or floor to open a detailed view. In the room view, you can see all tasks for that room. The floor view shows all rooms and tasks within that floor.
                  </p>
                </div>
              </div>
            </div>

            <!-- Adding and Managing Tasks -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingSeven">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSeven" aria-expanded="false" aria-controls="collapseSeven">
                  ‚ûï Adding and Managing Tasks
                </button>
              </h2>
              <div id="collapseSeven" class="accordion-collapse collapse" aria-labelledby="headingSeven" data-bs-parent="#helpAccordion">
                <div class="accordion-body">
                  <p style="padding: 10px; line-height: 1.5;">
                    To add a task, just click the "New Task" button, fill in the details, and assign it to a specific room or floor. To manage tasks, go to the specific room or floor page and use the edit or delete icons next to each task.
                  </p>
                </div>
              </div>
            </div>

            <!-- Helpful Tips -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingEight">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEight" aria-expanded="false" aria-controls="collapseEight">
                  üí° Helpful Tips
                </button>
              </h2>
              <div id="collapseEight" class="accordion-collapse collapse" aria-labelledby="headingEight" data-bs-parent="#helpAccordion">
                <div class="accordion-body">
                  <p style="padding: 10px; line-height: 1.5;">
                    Use the search bar at the top to quickly find specific tasks. The search term matches task names and descriptions. We're also planning to add filters to easily view tasks based on their status (e.g., pending, done).
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>


        <div class="modal-footer" style="border: 0;">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
{% endblock help_btn %}

{% block content %}
  {% if not workspace.floors.all %}
    <div class="message-container">
      <p class="message-text">
        You haven't added any floors to this workspace yet.<br>
        Please <span class="emphasis">add some floors</span> to get started.
      </p>
    </div>
  {% endif %}

  {% if global_workspaces.count > 1 %}
    <div class="message-container">
      <p class="message-text">
        It seems like you're assigned to multiple workspaces:
      </p>
      <ul class="workspace-list">
        {% for workspace in global_workspaces %}
          {% if workspace.id|stringformat:"s" == request.session.selected_workspace_id|stringformat:"s" %}
            <li class="workspace-item">
              <span style="color: #2ecc71; font-weight: bold;">Selected <i class="bi bi-arrow-right" style="color: #2ecc71;"></i></span> {{ workspace.name }}
            </li>
          {% else %}
            <li class="workspace-item">{{ workspace.name }}</li>
          {% endif %}
        {% endfor %}
      </ul>
      <p class="message-text">
        Click <a href="{% url 'task:workspaces' %}" class="switch-link">here</a> if you want to switch to another workspace.
      </p>
    </div>
  {% endif %}

  <div id="task-index-container">
    {% for floor in workspace.floors.all %}
      {% if  forloop.counter0|divisibleby:3 %}
        <div class="flex-break" style="flex-basis: 100%;height: 0;"> </div>
      {% endif %}
      <div class="floor-item">
        <div class="card my-0">
          <div class="card-header d-flex justify-content-between align-items-center"
               style="background: linear-gradient(90deg, rgba(0,0,0,1) 0%, {{ floor.color }}50 80%, {{ floor.color }} 100%)">
            <h4 class="card-title mb-0">
              <a href="{% url 'task:floor' floor.id %}" style="text-decoration: none;color: inherit;">
                {{ floor.icon }} {{ floor.name }}
              </a>
            </h4>
            <div>
              <button class="btn btn-dark btn-sm edit-floor-expand-button delete-btn" form-id="edit-floor-form-{{ floor.id }}">
                <i class="bi bi-pencil-fill"></i>
              </button>
              <form action="{% url 'task:remove_floor' floor.id %}"
                    method="post"
                    class="d-inline">
                {% csrf_token %}
                <button type="submit"
                        class="btn btn-dark btn-sm delete-btn"
                        onclick="return confirm('Are you sure you want to remove this floor?');">
                  <i class="bi bi-trash-fill"></i>
                </button>
              </form>
            </div>
            {% comment %}!|  edit floor form  |!{% endcomment %}
            </div>
              <div class="edit-floor-form" id="edit-floor-form-{{ floor.id }}">
                <form method="post"
                      action="{% url 'task:edit_floor' floor.id %}"
                      class="d-inline">
                  {% csrf_token %}
                  {% comment %} edit floor name {% endcomment %}
                  <div class="mb-3">
                    <input type="text"
                           class="form-control"
                           id="floorName"
                           name="floor_name"
                           placeholder="Floor Name"
                           value="{{ floor.name }}"
                           required />
                  </div>
                  {% comment %} edit floor emoji {% endcomment %}
                  <div class="mb-3" style="margin-bottom: 0px !important; display:flex; flex-wrap:wrap;">
                    <p style="margin-bottom:0px; text-align: center; width: 120px;">Select color <i class="bi bi-arrow-right-short"></i></p>
                    <input type="color"
                          class="form-control form-control-color"
                          name="floor_color"
                          title="Choose your color"
                          value="{{ floor.color }}"
                          style="width: 40px;
                                  height: 40px;
                                  padding: 0;
                                  box-shadow: 0 0 15px black;" />
                    <div style="flex-basis: 100%; height: 0;"></div>
                    <label for="floorEmoji" class="form-label">
                      Select an emoji <i class="bi bi-arrow-right-short"></i>
                    </label>
                    <input type="text"
                           class="form-control"
                           id="floorEmoji-edit-{{ floor.id }}-value"
                           name="floor_emoji"
                           value="{{ floor.icon }}"
                           required
                           hidden />
                    <button type="button"
                            class="btn btn-outline-secondary floor-emoji"
                            id="floorEmoji-edit-{{ floor.id }}">{{ floor.icon }}</button>
                    <button type="submit" class="btn btn-sm btn-success add-floor-button-submit">
                      <i class="bi bi-floppy2"></i> Save
                    </button>
                  </div>
                </form>
              </div>
          <div class="card-body floors-index">
            {% for room in floor.rooms.all %}
              <div class="mb-3 floors-index-item">
                <h5 class="d-flex justify-content-between align-items-center">
                  <a href="{% url 'task:room' room.id %}"
                     class="floors-index-room-redirect">{{ room.icon }} {{ room.name }} <div class="badge rounded-pill text-bg-secondary" title="Pending tasks left">{{ room.tasks|count_not_done }}</div> <i class="bi bi-eye"></i></a>
                  <div>
                    <!-- Room Edit and Delete buttons -->
                    <button class="btn btn-dark btn-sm edit-room-expand-button edit-btn" form-id="edit-room-form-{{ room.id }}">
                      <i class="bi bi-pencil-fill"></i>
                    </button>
                    <form method="post"
                          action="{% url 'task:remove_room' room.id %}"
                          class="d-inline">
                      {% csrf_token %}
                      <button type="submit"
                              class="btn btn-dark btn-sm delete-btn"
                              onclick="return confirm('Are you sure you want to remove this room?');">
                        <i class="bi bi-trash-fill"></i>
                      </button>
                    </form>
                  </div>
                </h5>
                {% comment %}!|  edit room form  |!{% endcomment %}
                <div id="edit-room-form-{{ room.id }}" class="edit-room-form">
                  <form method="post"
                        action="{% url 'task:edit_room' room.id %}"
                        class="d-inline">
                    {% csrf_token %}
                    {% comment %} edit room name {% endcomment %}
                    <div class="mb-3">
                      <input type="text"
                            class="form-control"
                            id="roomName"
                            name="room_name"
                            placeholder="Room Name"
                            value="{{ room.name }}"
                            required />
                    </div>
                    {% comment %} edit room emoji {% endcomment %}
                    <div class="mb-3" style="margin-bottom: 0px !important;">
                      <label for="roomEmoji" class="form-label">
                        Select an emoji <i class="bi bi-arrow-right-short"></i>
                      </label>
                      <input type="text"
                            class="form-control"
                            id="roomEmoji-edit-{{ room.id }}-value"
                            name="room_emoji"
                            value="{{ room.icon }}"
                            required
                            hidden />
                      <button type="button"
                              class="btn btn-outline-secondary room-emoji"
                              id="roomEmoji-edit-{{ room.id }}">{{ room.icon }}</button>
                      <button type="submit" class="btn btn-success btn-sm add-room-button-submit">
                        <i class="bi bi-floppy2"></i> Save
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            {% empty %}
              <p>No rooms added for this floor yet.</p>
            {% endfor %}
            <!-- Add Room form -->
            {% comment %}!|  add room form  |!{% endcomment %}
            <button class="btn btn-primary add-room-button"
                    formID="addRoomForm-{{ floor.id }}">
              <i class="bi bi-plus-circle"></i> Room
            </button>
            <form method="post"
                  action="{% url 'task:add_room' %}"
                  id="addRoomForm-{{ floor.id }}"
                  class="add-room-form">
              {% csrf_token %}
              <input type="hidden" name="floor_id" value="{{ floor.id }}" />
              <!-- Room Name Input -->
              <div class="mb-3">
                <input type="text"
                       class="form-control"
                       id="roomName"
                       name="room_name"
                       placeholder="Room Name"
                       required />
              </div>
              <!-- Emoji Picker for Room (placeholder) -->
              <div class="mb-3" style="margin-bottom: 0px !important;">
                <label for="roomEmoji" class="form-label">
                  Select an emoji <i class="bi bi-arrow-right-short"></i>
                </label>
                <input type="text"
                       class="form-control"
                       id="roomEmoji-{{ floor.id }}-value"
                       name="room_emoji"
                       value="ü§î"
                       required
                       hidden />
                <button type="button"
                        class="btn btn-outline-secondary room-emoji"
                        id="roomEmoji-{{ floor.id }}">ü§î</button>
                <button type="submit" class="btn btn-success add-room-button-submit">
                  <i class="bi bi-floppy2"></i> Add
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endfor %}
    <div>
      <div class="add-floor-form" id="addFloorForm">
        <form method="post" action="{% url 'task:add_floor' %}">
          <input type="hidden" name="workspace_id" value="{{ workspace.id }}" />
          {% csrf_token %}
          <div class="mb-2">
            <input type="text"
                  class="form-control"
                  name="floor_name"
                  placeholder="Floor Name"
                  required />
          </div>
          <div class="input-wrapper"
              style="display: flex;
                      align-items: center;
                      flex-wrap:wrap;
                      gap: 10px">

            <p style="margin-bottom:0px; text-align: center">Select color <i class="bi bi-arrow-right-short"></i></p>
            <input type="color"
                  class="form-control form-control-color"
                  name="floor_color"
                  title="Choose your color"
                  value="#800080"
                  style="width: 89px;
                          height: 89px;
                          padding: 0;
                          box-shadow: 0 0 15px black;" />

            <p style="margin-bottom:5px; margin-top: 5px;">Select emoji <i class="bi bi-arrow-right-short"></i></p>
            <input type="text"
                  class="form-control"
                  name="floor_emoji"
                  id="floorEmoji-value"
                  value="ü§î"
                  style="font-size: 50px;
                          width: 89px;
                          height: 89px;
                          text-align: center;
                          padding: 0"
                  required
                  hidden
                  readonly />

            <button type="button"
                    class="btn btn-outline-secondary btn-sm floor-emoji"
                    id="floorEmoji">ü§î</button>
          </div>
          <button type="submit" class="btn btn-success add-floor-btn-submit"><i class="bi bi-floppy2"></i> Add</button>
        </form>
      </div>
    </div>
  </div>
  <button type="button" class="btn btn-light {%if not workspace.floors.all %} throbbing {% endif %}" id="add-floor-expand-btn">
    <i class="bi bi-plus-circle"></i> Floor
  </button>
  <style>
    .message-container {
      background-color: #1e1e1e;
      border-left: 4px solid #4dabf7;
      border-radius: 4px;
      padding: 16px 20px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .message-text {
      font-family: 'Arial', sans-serif;
      font-size: 16px;
      line-height: 1.5;
      color: #e0e0e0;
      margin: 0 0 10px 0;
    }

    .workspace-list {
      list-style-type: none;
      padding: 0;
      margin: 0 0 15px 0;
    }

    .workspace-item {
      background-color: #2c2c2c;
      border-radius: 4px;
      color: #4dabf7;
      font-weight: 600;
      padding: 8px 12px;
      margin-bottom: 8px;
    }

    .switch-link {
      color: #74c0fc;
      text-decoration: underline;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .switch-link:hover {
      color: #a5d8ff;
    }

    .throbbing {
      animation: throb 2s infinite;
    }

    @keyframes throb {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
      100% {
        transform: scale(1);
      }
    }
  </style>
{% endblock content %}

