{% extends 'base.html' %}

{% load static i18n %}

{% block title %}
    Workspace management
{% endblock title %}

{% block viewSpecificCss %}
  <style>
    .workspace-selector-dropdown > button {
      width: 100%;
    }

    .card-body, .card-header, .card {
      border: 0;
    }

    .card-header {
      text-align: center;
    }

    .card {
      max-width: 600px;
      margin: 20px;
      height: 100%;
      box-shadow:
        0 0 15px black;
    }

    .list-group {
      box-shadow:
        0 0 10px rgb(0,0,0, 0.4);
    }

    .page-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      align-content: center;
      padding:0;
    }
  </style>
{% endblock viewSpecificCss %}

{% block help_btn %}
  <button type="button" class="btn btn-dark help-btn help-btn-pulsing" data-bs-toggle="modal" data-bs-target="#helpModal">
    <i class="bi bi-question-circle"></i>
  </button>

  <!-- Modal -->
  <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header" style="border: 0;">
          <h1 class="modal-title fs-5" id="helpModalLabel">Help</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="accordion" id="workspaceHelpAccordion">
            <!-- Workspace Overview -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="workspaceHeadingOne">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#workspaceCollapseOne" aria-expanded="true" aria-controls="workspaceCollapseOne">
                  üìã Workspace Overview
                </button>
              </h2>
              <div id="workspaceCollapseOne" class="accordion-collapse collapse show" aria-labelledby="workspaceHeadingOne" data-bs-parent="#workspaceHelpAccordion">
                <div class="accordion-body">
                  <p style="padding: 10px; line-height: 1.5;">
                    When you registered, we created a workspace just for you. This is your personal space where you can manage all your tasks, floors, and rooms. Think of it as your own digital command center!
                  </p>
                </div>
              </div>
            </div>

            <!-- Adding Users to Workspace -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="workspaceHeadingTwo">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#workspaceCollapseTwo" aria-expanded="false" aria-controls="workspaceCollapseTwo">
                  üë• Adding Users to Your Workspace
                </button>
              </h2>
              <div id="workspaceCollapseTwo" class="accordion-collapse collapse" aria-labelledby="workspaceHeadingTwo" data-bs-parent="#workspaceHelpAccordion">
                <div class="accordion-body">
                  <p style="padding: 10px; line-height: 1.5;">
                    Want to collaborate with others? You can add them to your workspace! Just enter their email in the "Add User to Workspace" section and click "Add User". It's a great way to share the load and keep everyone on the same page.
                  </p>
                  <img src="{% static 'images/add-users.png' %}" alt="Adding Users to Workspace" class="img-fluid mb-3" style="max-width: 100%; padding: 10px;">
                </div>
              </div>
            </div>

            <!-- Selecting Current Workspace -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="workspaceHeadingThree">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#workspaceCollapseThree" aria-expanded="false" aria-controls="workspaceCollapseThree">
                  üè† Choosing Your Current Workspace
                </button>
              </h2>
              <div id="workspaceCollapseThree" class="accordion-collapse collapse" aria-labelledby="workspaceHeadingThree" data-bs-parent="#workspaceHelpAccordion">
                <div class="accordion-body">
                  <p style="padding: 10px; line-height: 1.5;">
                    You can select which workspace you want to work with during your current session. Simply choose from the "Current Workspace" dropdown menu. This lets you switch between different workspaces easily.
                  </p>
                  <img src="{% static 'images/select-current-workspace.png' %}" alt="Selecting Current Workspace" class="img-fluid mb-3" style="max-width: 100%; padding: 10px;">
                </div>
              </div>
            </div>

            <!-- Selecting Default Workspace -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="workspaceHeadingFour">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#workspaceCollapseFour" aria-expanded="false" aria-controls="workspaceCollapseFour">
                  üåü Setting Your Default Workspace
                </button>
              </h2>
              <div id="workspaceCollapseFour" class="accordion-collapse collapse" aria-labelledby="workspaceHeadingFour" data-bs-parent="#workspaceHelpAccordion">
                <div class="accordion-body">
                  <p style="padding: 10px; line-height: 1.5;">
                    Want to save time? Set a default workspace to be automatically selected when you log in. Go to the "Select Default Workspace" section and choose your preferred workspace. It‚Äôs like setting your homepage!
                  </p>
                  <img src="{% static 'images/select-default-workspace.png' %}" alt="Selecting Default Workspace" class="img-fluid mb-3" style="max-width: 100%; padding: 10px;">
                </div>
              </div>
            </div>

            <!-- Example Scenario -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="workspaceHeadingFive">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#workspaceCollapseFive" aria-expanded="false" aria-controls="workspaceCollapseFive">
                  üí° Example Scenario
                </button>
              </h2>
              <div id="workspaceCollapseFive" class="accordion-collapse collapse" aria-labelledby="workspaceHeadingFive" data-bs-parent="#workspaceHelpAccordion">
                <div class="accordion-body">
                  <p style="padding: 10px; line-height: 1.5;">
                    Here‚Äôs a quick example: You register and start setting up floors and rooms in your workspace. Later, your partner also registers. You can add them to your workspace so they can help manage tasks. Then, they can set this shared workspace as their default, making collaboration a breeze!
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>


        <div class="modal-footer" style="border: 0;">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
{% endblock help_btn %}

{% block content %}
<h2 class="mb-4" style="text-align: center; margin-top:20px;">
  Workspaces <span class="badge bg-primary">{{ workspaces|length }}</span>
</h2>
  <div class="container mx-auto page-container">
    <div class="card mb-4">
      <div class="card-header">
        <h4 class="card-title">Current Workspace</h4>
      </div>
      <div class="card-body">
        <p><i class="bi bi-info-circle" style="color:darkturquoise"></i> Select which workspace's tasks to appear in this session</p>
        <ul class="list-group">
          <div class="dropdown workspace-selector-dropdown">
            <button class="btn btn-secondary dropdown-toggle dropdown-toggle-workspace bg-dark text-light"
                    type="button"
                    id="workspaceDropdown"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                    style="overflow: hidden;
                           text-overflow: ellipsis;
                           white-space: nowrap">
              {% for workspace in global_workspaces %}
                {% if workspace.id|stringformat:"s" == request.session.selected_workspace_id|stringformat:"s" %}
                  {{ workspace.name }}
                {% endif %}
              {% endfor %}
            </button>
            <ul class="dropdown-menu bg-dark" aria-labelledby="workspaceDropdown">
              {% for workspace in global_workspaces %}
                <li>
                  <!-- Each dropdown item is now a form that sends a POST request -->
                  <form action="{% url 'task:set_workspace' %}"
                        method="post"
                        class="dropdown-item">
                    {% csrf_token %}
                    <input type="hidden" name="workspace_id" value="{{ workspace.id }}" />
                    <button type="submit"
                            class="btn btn-link p-0 text-light"
                            style="text-decoration: none;
                                   color: inherit">{{ workspace.name }}</button>
                  </form>
                </li>
              {% endfor %}
            </ul>
          </div>
        </ul>
      </div>
    </div>
    <div class="card mb-4">
      <div class="card-header">
        <h4 class="card-title">Select default Workspace</h4>
      </div>
      <div class="card-body">
        <p><i class="bi bi-info-circle" style="color:darkturquoise"></i> This is the workspace that will be selected when you log in.</p>
        <ul class="list-group">
          <div class="dropdown workspace-selector-dropdown">
            <button class="btn btn-secondary dropdown-toggle dropdown-toggle-workspace bg-dark text-light"
                    type="button"
                    id="workspaceDropdown"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                    style="overflow: hidden;
                           text-overflow: ellipsis;
                           white-space: nowrap">
              {% for workspace in global_workspaces %}
                {% if workspace.id|stringformat:"s" == request.session.selected_workspace_id|stringformat:"s" %}
                  {{ workspace.name }}
                {% endif %}
              {% endfor %}
            </button>
            <ul class="dropdown-menu bg-dark" aria-labelledby="workspaceDropdown">
              {% for workspace in global_workspaces %}
                <li>
                  <!-- Each dropdown item is now a form that sends a POST request -->
                  <form action="{% url 'task:set_default_workspace' %}"
                        method="post"
                        class="dropdown-item">
                    {% csrf_token %}
                    <input type="hidden" name="workspace_id" value="{{ workspace.id }}" />
                    <button type="submit"
                            class="btn btn-link p-0 text-light"
                            style="text-decoration: none;
                                   color: inherit">{{ workspace.name }}</button>
                  </form>
                </li>
              {% endfor %}
            </ul>
          </div>
        </ul>
      </div>
    </div>
    <div class="card mb-4">
      <div class="card-header">
        <h4 class="card-title">Current Workspace info</h4>
      </div>
      <div class="card-body">
        <p>
          Created by
          {% if selected_workspace.created_by == request.user %}
            <strong>you</strong>
          {% else %}
            <strong>{{ selected_workspace.created_by }}</strong>
          {% endif %}
        </p>
        <h4 class="mt-4">Users with Access to this workspace</h4>
        <ul class="list-group mb-4">
          {% for user in selected_workspace.users.all %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              {{ user.email }}
              {% if user != selected_workspace.created_by and request.user == selected_workspace.created_by %}
                <form method="post"
                      action="{% url 'task:remove_user_from_workspace' %}"
                      class="d-inline"
                      onsubmit="return confirm('Are you sure you want to remove user {{ user.email }} from the workspace?');">
                  {% csrf_token %}
                  <input type="hidden" name="email" value="{{ user.email }}" />
                  <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                </form>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
        {% if request.user == selected_workspace.created_by %}
          <h4>Add User to your Workspace</h4>
          <form method="post" action="{% url 'task:add_user_to_workspace' %}">
            {% csrf_token %}
            <div class="input-group">
              <input type="email"
                     name="email"
                     class="form-control"
                     placeholder="Enter user email"
                     required />
              <button type="submit" class="btn btn-primary">Add User</button>
            </div>
          </form>
        {% endif %}
      </div>
    </div>
  </div>
  <script>
    const dropdown_toggles = document.querySelectorAll('.dropdown-toggle-workspace');

    dropdown_toggles.forEach((dropdown_toggle) => {
      dropdown_toggle.addEventListener('click', function() {
        const dropdown_menu = dropdown_toggle.nextElementSibling;
        dropdown_menu.classList.toggle('show');
      });
    });
  </script>
{% endblock content %}

